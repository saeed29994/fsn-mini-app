<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlySky Network - Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #00d4aa;
            --bg-dark: #0a0e17;
            --card-dark: #1a1f35;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: white;
            min-height: 100vh;
            padding: 20px;
            background-image: radial-gradient(circle at 20% 80%, rgba(67, 97, 238, 0.15) 0%, transparent 50%);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        .logo {
            font-size: 64px;
            margin: 40px 0 20px;
            color: var(--primary);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        h1 {
            font-size: 36px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }
        
        .subtitle {
            color: #8a94b3;
            font-size: 18px;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        
        .card {
            background: var(--card-dark);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            border: 1px solid rgba(67, 97, 238, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 18px 36px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
        }
        
        .btn-telegram {
            background: linear-gradient(135deg, #0088cc, #34a853);
        }
        
        .btn-guest {
            background: transparent;
            border: 2px solid var(--primary);
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .feature {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .feature i {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .feature h3 {
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .status {
            padding: 15px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
        }
        
        .hidden {
            display: none;
        }
        
        .demo-warning {
            background: linear-gradient(135deg, #ff6b9d, #ff8e53);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>
    <div class="container">
        <div class="logo">??</div>
        <h1>FlySky Network</h1>
        <p class="subtitle">Earn FSN tokens by mining virtual flights and watching ads. Join thousands of users worldwide!</p>
        
        <div class="demo-warning">
            <i class="fas fa-info-circle"></i> DEMO VERSION - For full features, open in Telegram Mini App
        </div>
        
        <div class="card">
            <h2 style="margin-bottom: 20px;">Welcome to FlySky</h2>
            <p style="margin-bottom: 25px; color: #8a94b3;">Choose how you want to continue:</p>
            
            <div class="status" id="telegram-status">
                <i class="fas fa-sync fa-spin"></i> Detecting environment...
            </div>
            
            <button class="btn btn-telegram" onclick="loginWithTelegram()" id="telegram-btn">
                <i class="fab fa-telegram"></i> Login with Telegram
            </button>
            
            <button class="btn btn-guest" onclick="continueAsGuest()" id="guest-btn">
                <i class="fas fa-user"></i> Continue as Guest
            </button>
        </div>
        
        <div class="features">
            <div class="feature">
                <i class="fas fa-hammer"></i>
                <h3>Flight Mining</h3>
                <p>Mine virtual flights and earn FSN tokens</p>
            </div>
            <div class="feature">
                <i class="fas fa-tv"></i>
                <h3>Watch & Earn</h3>
                <p>Watch ads and get rewarded instantly</p>
            </div>
            <div class="feature">
                <i class="fas fa-crown"></i>
                <h3>Upgrade Packages</h3>
                <p>Unlock higher rewards with premium packages</p>
            </div>
            <div class="feature">
                <i class="fas fa-share-alt"></i>
                <h3>Refer Friends</h3>
                <p>Earn commission from referrals</p>
            </div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(0, 212, 170, 0.1));">
            <h3>How to use this Mini App:</h3>
            <p style="margin: 15px 0; color: #8a94b3;">
                1. Open in Telegram via @fsncrewbot<br>
                2. Login automatically with your Telegram account<br>
                3. Start mining and earning immediately
            </p>
            <button class="btn" onclick="openTelegram()" style="background: linear-gradient(135deg, #0088cc, #34a853);">
                <i class="fab fa-telegram"></i> Open in Telegram
            </button>
        </div>
    </div>

    <script>
        // Telegram WebApp
        const tg = window.Telegram?.WebApp;
        
        // DOM Elements
        const telegramStatus = document.getElementById('telegram-status');
        const telegramBtn = document.getElementById('telegram-btn');
        const guestBtn = document.getElementById('guest-btn');
        
        // Initialize
        function init() {
            console.log('Initializing FlySky Mini App...');
            
            if (tg) {
                // Telegram WebApp detected
                tg.expand();
                tg.setBackgroundColor('#0a0e17');
                tg.setHeaderColor('#4361ee');
                tg.enableClosingConfirmation();
                
                telegramStatus.innerHTML = `
                    <i class="fas fa-check-circle"></i> Telegram Mini App detected<br>
                    <small>You can login automatically</small>
                `;
                telegramBtn.disabled = false;
                
                // Check if we have initData (user is in Telegram)
                if (tg.initData) {
                    console.log('Telegram initData available:', tg.initData.length, 'chars');
                    // Try auto-login after 1 second
                    setTimeout(() => {
                        loginWithTelegram();
                    }, 1000);
                } else {
                    console.log('No initData - user needs to click login');
                }
                
            } else {
                // Not in Telegram - running in browser
                telegramStatus.innerHTML = `
                    <i class="fas fa-globe"></i> Running in browser mode<br>
                    <small>For full features, open in Telegram</small>
                `;
                telegramBtn.disabled = false;
                telegramBtn.innerHTML = '<i class="fab fa-telegram"></i> Login with Telegram (Mock)';
                guestBtn.style.display = 'block';
            }
        }
        
        // Login with Telegram
        async function loginWithTelegram() {
            telegramBtn.disabled = true;
            telegramBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            
            try {
                if (tg?.initData) {
                    // Real Telegram login
                    console.log('Attempting Telegram login with initData');
                    
                    const response = await fetch('/api/auth/telegram-login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ initData: tg.initData })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Login failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log('Login successful:', data.user);
                        
                        // Save token and user data
                        localStorage.setItem('flysky_token', data.token);
                        localStorage.setItem('flysky_user', JSON.stringify(data.user));
                        
                        // Redirect to dashboard
                        window.location.href = '/dashboard';
                        
                    } else {
                        throw new Error(data.error || 'Login failed');
                    }
                    
                } else {
                    // Mock login for browser testing
                    console.log('Using mock login for browser testing');
                    
                    const mockUser = {
                        id: 'browser_user_' + Date.now(),
                        telegram_id: null,
                        telegram_first_name: 'Guest',
                        telegram_last_name: 'User',
                        fsn_balance: 500,
                        current_package: 'economy',
                        limits: {
                            mining_reward: 25,
                            max_ads_daily: 10,
                            mining_cooldown: 180
                        }
                    };
                    
                    localStorage.setItem('flysky_token', 'browser_mock_token_' + Date.now());
                    localStorage.setItem('flysky_user', JSON.stringify(mockUser));
                    
                    // Show success and redirect
                    telegramStatus.innerHTML = `
                        <i class="fas fa-check-circle"></i> Logged in as Guest<br>
                        <small>Redirecting to dashboard...</small>
                    `;
                    
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Login error:', error);
                
                telegramStatus.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> Login failed<br>
                    <small>${error.message}</small>
                `;
                
                telegramBtn.disabled = false;
                telegramBtn.innerHTML = '<i class="fab fa-telegram"></i> Try Again';
                
                // For testing, allow guest mode
                setTimeout(() => {
                    continueAsGuest();
                }, 2000);
            }
        }
        
        // Continue as guest
        function continueAsGuest() {
            console.log('Continuing as guest');
            
            // Create guest user data
            const guestUser = {
                id: 'guest_' + Date.now(),
                telegram_id: null,
                telegram_first_name: 'Guest',
                telegram_last_name: 'User',
                fsn_balance: 250, // Less balance for guests
                current_package: 'economy',
                limits: {
                    mining_reward: 10,
                    max_ads_daily: 5,
                    mining_cooldown: 300
                },
                daily_stats: {
                    mining_today: 0,
                    ads_watched: 0
                },
                is_guest: true
            };
            
            localStorage.setItem('flysky_token', 'guest_token_' + Date.now());
            localStorage.setItem('flysky_user', JSON.stringify(guestUser));
            localStorage.setItem('flysky_guest_mode', 'true');
            
            telegramStatus.innerHTML = `
                <i class="fas fa-user"></i> Continuing as Guest<br>
                <small>Redirecting to dashboard...</small>
            `;
            
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 1000);
        }
        
        // Open in Telegram
        function openTelegram() {
            const telegramUrl = 'https://t.me/fsncrewbot';
            
            if (tg?.openTelegramLink) {
                tg.openTelegramLink(telegramUrl);
            } else {
                window.open(telegramUrl, '_blank');
            }
        }
        
        // Check for existing session
        function checkExistingSession() {
            const token = localStorage.getItem('flysky_token');
            const user = localStorage.getItem('flysky_user');
            
            if (token && user) {
                console.log('Existing session found');
                telegramStatus.innerHTML = `
                    <i class="fas fa-check-circle"></i> Session found<br>
                    <small>Redirecting to dashboard...</small>
                `;
                
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1500);
            }
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            init();
            checkExistingSession();
        });
    </script>
<script src="global-functions.js"></script><script src="telegram-fix.js"></script><script src="mining-functions.js"></script></body>
</html>





